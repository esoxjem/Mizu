name: Release

on:
  push:
    tags:
    - 'v*'

jobs:
  release:
    runs-on: macos-latest
    permissions:
      contents: write

    env:
      KEYCHAIN_NAME: build.keychain
      KEYCHAIN_PASSWORD: ${{ github.run_id }}
      SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate version matches tag
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          TAG_VERSION="${TAG_NAME#v}"

          if ! echo "$TAG_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "::error::Invalid tag format '$TAG_NAME'. Expected: vX.Y.Z"
            exit 1
          fi

          XCODE_VERSION=$(grep -A1 'MARKETING_VERSION' Mizu.xcodeproj/project.pbxproj | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)

          if [ "$TAG_VERSION" != "$XCODE_VERSION" ]; then
            echo "::error::Version mismatch! Tag is $TAG_VERSION but Xcode MARKETING_VERSION is $XCODE_VERSION"
            echo "Please update MARKETING_VERSION in Xcode to $TAG_VERSION before tagging."
            exit 1
          fi

          echo "âœ“ Version validated: $TAG_VERSION"

      - name: Download Sparkle tools
        run: |
          curl -LO https://github.com/sparkle-project/Sparkle/releases/download/2.8.1/Sparkle-2.8.1.tar.xz
          mkdir sparkle-tools
          tar -xf Sparkle-2.8.1.tar.xz -C sparkle-tools

      - name: Install certificate
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"

          # Import certificate
          echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 -k "$KEYCHAIN_NAME" -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          rm certificate.p12

          # Set keychain to be used for code signing
          security list-keychains -d user -s "$KEYCHAIN_NAME" login.keychain
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"

      - name: Build
        run: xcodebuild -scheme "Mizu" -project Mizu.xcodeproj build

      - name: Archive
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          mkdir ./archives
          xcodebuild -scheme "Mizu" \
            -archivePath "./archives/Mizu.xcarchive" \
            -project Mizu.xcodeproj \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            archive

      - name: Export
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Create export options plist with team ID
          cat > exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>developer-id</string>
            <key>teamID</key>
            <string>${APPLE_TEAM_ID}</string>
            <key>signingStyle</key>
            <string>automatic</string>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath "./archives/Mizu.xcarchive/" \
            -exportOptionsPlist exportOptions.plist \
            -exportPath "./archives"

      - name: Notarize app
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Create ZIP for notarization
          ditto -c -k --keepParent "./archives/Mizu.app" "./archives/Mizu-notarize.zip"

          # Submit for notarization and capture output
          NOTARIZE_OUTPUT=$(xcrun notarytool submit "./archives/Mizu-notarize.zip" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait 2>&1) || true

          echo "$NOTARIZE_OUTPUT"

          # Extract submission ID and check status
          SUBMISSION_ID=$(echo "$NOTARIZE_OUTPUT" | grep "id:" | head -1 | awk '{print $2}')

          if echo "$NOTARIZE_OUTPUT" | grep -q "status: Invalid"; then
            echo "Notarization failed. Fetching detailed log..."
            xcrun notarytool log "$SUBMISSION_ID" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_ID_PASSWORD" \
              --team-id "$APPLE_TEAM_ID"
            exit 1
          fi

          # Staple the ticket to the app
          xcrun stapler staple "./archives/Mizu.app"

          rm "./archives/Mizu-notarize.zip"

      - name: Create DMG
        run: |
          npm install --global create-dmg
          create-dmg ./archives/Mizu.app ./archives || true

      - name: Sign and notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Rename DMG
          mv ./archives/Mizu*.dmg ./archives/Mizu.dmg

          # Sign the DMG
          codesign --force --sign "Developer ID Application" ./archives/Mizu.dmg

          # Notarize the DMG
          xcrun notarytool submit "./archives/Mizu.dmg" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_ID_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

          # Staple the DMG
          xcrun stapler staple "./archives/Mizu.dmg"

      - name: Create ZIP
        run: |
          cd ./archives
          zip -r -X Mizu.zip Mizu.app

      - name: Generate appcast
        env:
          TAG_NAME: ${{ github.ref_name }}
        run: |
          mkdir -p updates
          cp ./archives/Mizu.zip ./updates/

          echo "$SPARKLE_PRIVATE_KEY" | ./sparkle-tools/bin/generate_appcast \
            --ed-key-file - \
            --download-url-prefix "https://github.com/esoxjem/Mizu/releases/download/${TAG_NAME}/" \
            ./updates

          mv ./updates/appcast.xml ./appcast.xml

      - name: Commit appcast
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add appcast.xml
          git diff --staged --quiet || git commit -m "Update appcast.xml for ${{ github.ref_name }}"
          git push origin HEAD:main

      - name: Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "./archives/Mizu.zip,./archives/Mizu.dmg"
          makeLatest: true

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain "$KEYCHAIN_NAME" || true
